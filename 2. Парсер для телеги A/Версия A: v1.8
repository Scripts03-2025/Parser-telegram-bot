# === telegram_search_save_results.py ===
# –í–µ—Ä—Å–∏—è: v1.8 ‚Äî Selenium-only, –±–µ–∑ –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML
# ChatGPT Thread: https://chatgpt.com/c/67f6e99b-1044-8010-9bb3-b4c98ba73881

from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from datetime import datetime
import pandas as pd
import time
import os
import re

# üìÅ –ü—É—Ç–∏
profile_path = os.path.abspath("ChromeUserProfile")
output_path = r"C:\Users\CL\Documents\–û–±—â–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ —Å –≥—É–≥–ª –¥–æ–∫–æ–º (Google Drive)\–¢–µ–ª–µ–≥—Ä–∞–º –ø–∞—Ä—Å–µ—Ä –≤—ã–¥–∞—á–∏ –ø–æ —Ä–∞–∑–¥–µ–≤–∞–ª–∫–∞–º"
filename = os.path.join(output_path, "telegram_results.xlsx")
os.makedirs(profile_path, exist_ok=True)

# üîç –ó–∞–ø—Ä–æ—Å—ã
queries = [
    "–†–∞–∑–¥–µ—Ç—å –¥–µ–≤—É—à–∫—É",
    "–†–∞–∑–¥–µ–≤–∞—Ç–æ—Ä",
    "–†–∞–∑–¥–µ—Ç—å –¥–µ–≤—É—à–∫—É –ø–æ —Ñ–æ—Ç–æ",
    "–†–∞–∑–¥–µ—Ç—å —Ñ–æ—Ç–æ",
    "–†–∞–∑–¥–µ—Ç—å –ø–æ —Ñ–æ—Ç–æ",
    "–°–Ω—è—Ç—å –æ–¥–µ–∂–¥—É",
    "–ë–æ—Ç –¥–ª—è —Ä–∞–∑–¥–µ–≤–∞–Ω–∏—è",
    "–†–∞–∑–¥–µ—Ç—å"
]

# ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞
options = Options()
options.add_argument(f"--user-data-dir={profile_path}")
options.add_argument("--start-maximized")

driver = webdriver.Chrome(options=options)
wait = WebDriverWait(driver, 15)

# üï∏ Telegram Web
driver.get("https://web.telegram.org/k/")
time.sleep(8)

# üìÖ –î–∞—Ç–∞
today = datetime.now().strftime("%d.%m.%Y")

# üìÇ –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
if os.path.exists(filename):
    df_existing = pd.read_excel(filename)
else:
    df_existing = pd.DataFrame(columns=["–î–∞—Ç–∞", "–ó–∞–ø—Ä–æ—Å", "–ù–∞–∑–≤–∞–Ω–∏–µ", "–°—Å—ã–ª–∫–∞", "–ü–æ–¥–ø–∏—Å—á–∏–∫–∏", "–¢–∏–ø"])

# üì• –°–±–æ—Ä
new_rows = []

for query in queries:
    print(f"\nüîé –ü–æ–∏—Å–∫: {query}")
    try:
        search_box = wait.until(EC.presence_of_element_located(
            (By.XPATH, '//input[contains(@class, "input-search-input")]')
        ))
        search_box.clear()
        search_box.send_keys(query)
        time.sleep(4)

        results = driver.find_elements(By.XPATH, '//a[contains(@class, "chatlist-chat")]')
        print(f"   –ù–∞–π–¥–µ–Ω–æ: {len(results)}")

        for result in results:
            try:
                title = result.find_element(By.CLASS_NAME, "peer-title").text.strip()
                subtitle = result.find_element(By.CLASS_NAME, "row-subtitle").text.strip()

                # –°—Å—ã–ª–∫–∞
                username_match = re.search(r"@[\w\d_]+", subtitle)
                link = f"https://t.me/{username_match.group(0)[1:]}" if username_match else ""

                # –ü–æ–¥–ø–∏—Å—á–∏–∫–∏
                subs_match = re.search(r"(\d[\d\s]*)\s+(subscribers|members)", subtitle, re.IGNORECASE)
                subscribers = int(subs_match.group(1).replace(" ", "")) if subs_match else ""

                # –¢–∏–ø
                if "bot" in subtitle.lower():
                    obj_type = "–ë–æ—Ç"
                elif "subscribers" in subtitle.lower():
                    obj_type = "–ö–∞–Ω–∞–ª"
                elif "members" in subtitle.lower():
                    obj_type = "–ß–∞—Ç"
                else:
                    obj_type = "?"

                new_rows.append([today, query, title, link, subscribers, obj_type])

            except Exception as e:
                print("‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω –æ–¥–∏–Ω –±–ª–æ–∫:", e)

    except Exception as e:
        print("‚ùå –û—à–∏–±–∫–∞:", e)

# üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
df_new = pd.DataFrame(new_rows, columns=["–î–∞—Ç–∞", "–ó–∞–ø—Ä–æ—Å", "–ù–∞–∑–≤–∞–Ω–∏–µ", "–°—Å—ã–ª–∫–∞", "–ü–æ–¥–ø–∏—Å—á–∏–∫–∏", "–¢–∏–ø"])
df_filtered = df_existing[df_existing["–î–∞—Ç–∞"] != today]
df_final = pd.concat([df_filtered, df_new], ignore_index=True)
df_final.to_excel(filename, index=False, sheet_name="Telegram")

print(f"\n‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ {filename}")
input("‚èπ –ù–∞–∂–º–∏ Enter, —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç—å –±—Ä–∞—É–∑–µ—Ä...")
driver.quit()

# === üìò –°–ø—Ä–∞–≤–∫–∞ –ø–æ –≤–µ—Ä—Å–∏–∏ v1.8 ===
# –ß–∏—Å—Ç—ã–π Selenium, –±–µ–∑ BS4
# –ù–∞—Ö–æ–¥–∏—Ç –≤–∏–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤—ã–¥–∞—á–∏
# –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Excel: –¥–∞—Ç–∞, –∑–∞–ø—Ä–æ—Å, –Ω–∞–∑–≤–∞–Ω–∏–µ, —Å—Å—ã–ª–∫–∞, –ø–æ–¥–ø–∏—Å—á–∏–∫–∏, —Ç–∏–ø
#
# üëâ –ó–∞–ø—É—Å–∫:
#     python telegram_search_save_results.py
